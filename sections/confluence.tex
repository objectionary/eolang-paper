% SPDX-FileCopyrightText: Copyright (c) 2016-2025 Objectionary.com
% SPDX-License-Identifier: MIT

\section{Confluence}\label{sec:confluence}

In this section we prove that the reduction strategy in \cref{fig:reduction} is \emph{confluent},
  i.e., possesses the Churchâ€“Rosser property~\citep{church1936some}.
This means that if there are reduction sequences from any expression to two different expressions,
  then there exist reduction sequences from those two expressions to some common expression.

\begin{lemma}[Root Determinism]
\label{lemma:root}
For any expression \(e\), at most one reduction rule applies at the root of \(e\).
\end{lemma}

\begin{proof}
Inspection of the rules in \cref{fig:reduction} shows that their left-hand sides are
  distinguished by mutually exclusive syntactic and semantic conditions: for example,
    rules \nameref{r:dot} and \nameref{r:null} require the same attribute to be attached to a normal form or to $?$, respectively;
    rules \nameref{r:phi} and \nameref{r:stop} differ by the presence of $@$;
    rules \nameref{r:stay} and \nameref{r:over} differ by the applied attribute;
    and
    \nameref{r:alpha} is explicitly excluded by the side condition of \nameref{r:miss}.
  Hence no two distinct rules can match the same expression at the same root position.
\end{proof}

\begin{lemma}[Local Confluence]
\label{lemma:local}
If \(e \trans e_1\) and \(e \trans e_2\), then there exists an expression \(e_3\) such that \(e_1 \strans e_3\) and \(e_2 \strans e_3\).
\end{lemma}

\begin{proof}
If the two redexes occur in disjoint subexpressions, the reductions commute by context closure, yielding a common successor in two steps.

Otherwise, one redex is nested within the other.
By \cref{lemma:root}, the outer redex is uniquely determined.
The only rules whose contracta depend on evaluating a subexpression are \nameref{r:copy} and \nameref{r:dot}.

In rule \nameref{r:dot}, the attribute value on the left-hand side is already a normal form,
  so no inner reduction can interfere with the rule application.

In rule \nameref{r:copy}, the replaced expression is the normal form of a strictly smaller expression \(\ctx{a}{\scopeof{a}}\).
Because of that, the joinability of the two normalization paths
\begin{equation*}
\ctx{a}{\scopeof{a}} \strans n \qquad\text{and}\qquad \ctx{a}{\scopeof{a}} \trans \ctx{a'}{\scopeof{a}} \strans n'
\end{equation*}
reduces to the induction hypothesis on smaller expressions.
Consequently, \(n\) and \(n'\) have a common successor, but being normal forms they must coincide.
This closes the peak.
\end{proof}

\begin{theorem}[Confluence]
Any expression may have only one normal form.
\end{theorem}

\begin{proof}
By \cref{lemma:local}, \(\trans\) is locally confluent.
Since reductions are closed under contexts, any finite reduction peak can be decomposed into one-step peaks, each of which is joinable.
By repeated joining, any two reduction sequences from a common source can be joined to a common successor.
Hence \(\trans\) is confluent.
\end{proof}
